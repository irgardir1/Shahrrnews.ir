const rssSources = {
  "Ø³ÛŒØ§Ø³ÛŒ": [
    "https://www.shahrekhabar.com/rss.aspx?cat=1"
  ],
  "Ø§Ù‚ØªØµØ§Ø¯ÛŒ": [
    "https://www.shahrekhabar.com/rss.aspx?cat=2"
  ],
  "ÙˆØ±Ø²Ø´ÛŒ": [
    "https://www.shahrekhabar.com/rss.aspx?cat=3"
  ],
  "ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ": [
    "https://www.shahrekhabar.com/rss.aspx?cat=4"
  ]
};

const newsEl = document.getElementById("news");
const catEl = document.getElementById("categories");
const breakingEl = document.getElementById("breaking");
const darkBtn = document.getElementById("darkBtn");

/* Ø³Ø§Ø®Øª Ø¯Ú©Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ */
Object.keys(rssSources).forEach((cat, i) => {
  const btn = document.createElement("button");
  btn.textContent = cat;
  if (i === 0) btn.classList.add("active");
  btn.onclick = () => loadCategory(cat, btn);
  catEl.appendChild(btn);
});

/* Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ RSS Ø¨Ø§ rss2json (Ø¨Ø¯ÙˆÙ† CORS) */
async function loadCategory(cat, btn) {
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");

  newsEl.innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø®Ø¨Ø§Ø±...";
  let allItems = [];

  for (const rss of rssSources[cat]) {
    const url = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rss)}`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.items) {
        allItems.push(...data.items);
      }
    } catch (e) {
      console.error("RSS Error:", e);
    }
  }

  renderNews(allItems);
}

/* Ù†Ù…Ø§ÛŒØ´ Ø®Ø¨Ø±Ù‡Ø§ */
function renderNews(items) {
  newsEl.innerHTML = "";

  if (!items.length) {
    newsEl.innerHTML = "Ø®Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯";
    return;
  }

  items.slice(0, 20).forEach((item, idx) => {
    if (idx === 0) {
      breakingEl.textContent = "ğŸ”” Ø®Ø¨Ø± ÙÙˆØ±ÛŒ: " + item.title;
    }

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img src="${item.thumbnail || `https://source.unsplash.com/600x400/?news,${idx}`}">
      <div class="content">
        <h3>${item.title}</h3>
        <div class="meta">
          ${new Date(item.pubDate).toLocaleDateString("fa-IR")}
        </div>
        <p>${stripHTML(item.description).slice(0,120)}...</p>
        <a href="${item.link}" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø®Ø¨Ø±</a>
        <br>
        <button class="fav" onclick="toggleFav('${escapeQuotes(item.title)}','${item.link}')">â¤ï¸</button>
      </div>
    `;
    newsEl.appendChild(card);
  });
}

/* Ø­Ø°Ù ØªÚ¯â€ŒÙ‡Ø§ÛŒ HTML */
function stripHTML(html) {
  const div = document.createElement("div");
  div.innerHTML = html || "";
  return div.textContent || div.innerText || "";
}

/* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø´Ú©Ø³ØªÙ† onclick */
function escapeQuotes(text){
  return text.replace(/'/g, "\\'");
}

/* Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ */
function toggleFav(title, link) {
  let favs = JSON.parse(localStorage.getItem("favs") || "[]");
  const index = favs.findIndex(f => f.link === link);

  if (index > -1) {
    favs.splice(index, 1);
  } else {
    favs.push({ title, link });
  }

  localStorage.setItem("favs", JSON.stringify(favs));
}

/* Ø¯Ø§Ø±Ú© Ù…ÙˆØ¯ */
darkBtn.onclick = () => {
  document.body.classList.toggle("dark");
};

/* Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ */
loadCategory(
  Object.keys(rssSources)[0],
  document.querySelector("nav button")
);
